# X√¢y d·ª±ng Data Marts c∆° b·∫£n v·ªõi DBT v√† Snowflake

![Banner](https://img.shields.io/badge/Tech%20Stack-Python%20|%20DBT%20|%20Snowflake%20|%20Docker%20|%20Astro%20Cosmos%20|%20Apache%20Airflow-blue)  
**H·ªá ƒëi·ªÅu h√†nh**: Ubuntu  
**M√¥ t·∫£**: D·ª± √°n tri·ªÉn khai Data Warehouse (DWH) s·ª≠ d·ª•ng DBT k·∫øt h·ª£p Snowflake, t√≠ch h·ª£p pipeline v·ªõi Apache Airflow th√¥ng qua Docker v√† Astro Cosmos.

---

## üìã Y√™u c·∫ßu c√¥ng ngh·ªá

| C√¥ng ngh·ªá          | Phi√™n b·∫£n/Th√¥ng tin                     |
|--------------------|-----------------------------------------|
| H·ªá ƒëi·ªÅu h√†nh       | Ubuntu                                 |
| Ng√¥n ng·ªØ l·∫≠p tr√¨nh | Python 3.x                             |
| C√¥ng c·ª• DWH        | DBT (dbt-snowflake)                    |
| Database           | Snowflake                              |
| Orchestration      | Apache Airflow (Astro Cosmos)          |
| Containerization   | Docker                                 |

![Banner](https://media.licdn.com/dms/image/v2/D4D10AQGvGTJ0d90WkA/image-shrink_800/image-shrink_800/0/1707302479959?e=2147483647&v=beta&t=gn4nz7vAe8PkwdGp3I3sHQSmBaufD__nn1Hr0sbt2AQ)  

---

## üõ† H∆∞·ªõng d·∫´n Setup v√† Tri·ªÉn khai

### 1. Snowflake ‚ùÑÔ∏è

1. **T·∫°o t√†i kho·∫£n Snowflake**  
   - Truy c·∫≠p [Snowflake Signup](https://signup.snowflake.com/) ƒë·ªÉ ƒëƒÉng k√Ω t√†i kho·∫£n.

2. **C·∫•u h√¨nh Snowflake**  
   ƒêƒÉng nh·∫≠p v√† thi·∫øt l·∫≠p c√°c th√†nh ph·∫ßn c·∫ßn thi·∫øt: DATABASE, WAREHOUSE, SCHEMA, ROLE.

   ```sql
   -- Chuy·ªÉn sang role ACCOUNTADMIN
   USE ROLE ACCOUNTADMIN;

   -- T·∫°o warehouse
   CREATE WAREHOUSE dbt_wh WITH WAREHOUSE_SIZE = 'X-SMALL';

   -- T·∫°o database
   CREATE DATABASE dbt_db;

   -- T·∫°o role cho DBT
   CREATE ROLE dbt_role;

   -- Ki·ªÉm tra quy·ªÅn tr√™n warehouse
   SHOW GRANTS ON WAREHOUSE dbt_wh;

   -- G√°n quy·ªÅn s·ª≠ d·ª•ng warehouse
   GRANT USAGE ON WAREHOUSE dbt_wh TO ROLE dbt_role;

   -- G√°n role cho user
   GRANT ROLE dbt_role TO USER tunguyen150599;

   -- C·∫•p to√†n b·ªô quy·ªÅn tr√™n database
   GRANT ALL ON DATABASE dbt_db TO ROLE dbt_role;

   -- Chuy·ªÉn sang role DBT
   USE ROLE dbt_role;

   -- T·∫°o schema
   CREATE SCHEMA dbt_db.dbt_schema;
   ```

---

### 2. Python v√† DBT üêç

1. **C√†i ƒë·∫∑t Visual Studio Code**  
   - T·∫£i v√† c√†i ƒë·∫∑t [VS Code](https://code.visualstudio.com/) tr√™n Ubuntu.

2. **T·∫°o m√¥i tr∆∞·ªùng ·∫£o (venv)**  
   - T·∫°o th∆∞ m·ª•c d·ª± √°n v√† kh·ªüi t·∫°o m√¥i tr∆∞·ªùng ·∫£o:

   ```bash
   python3 -m venv venv
   source venv/bin/activate
   ```

3. **C√†i extension DBT Power User**  
   - C√†i ƒë·∫∑t [DBT Power User](https://marketplace.visualstudio.com/items?itemName=innoverio.vscode-dbt-power-user) tr√™n VS Code.

4. **T·∫°o th∆∞ m·ª•c `.dbt`**  
   - T·∫°o th∆∞ m·ª•c `.dbt` t·∫°i `$HOME` ƒë·ªÉ l∆∞u tr·ªØ c·∫•u h√¨nh b·∫£o m·∫≠t:

   ```bash
   cd $HOME
   mkdir .dbt
   ```

5. **C√†i ƒë·∫∑t DBT**  
   - Quay l·∫°i th∆∞ m·ª•c d·ª± √°n v√† c√†i ƒë·∫∑t `dbt-snowflake`:

   ```bash
   pip install dbt-snowflake
   ```

   - Kh·ªüi t·∫°o d·ª± √°n DBT:

   ```bash
   dbt init
   ```

6. **C·∫•u h√¨nh d·ª± √°n DBT**  
   - ƒêi·ªÅn th√¥ng tin c·∫•u h√¨nh khi ch·∫°y `dbt init`:
     - **Project Name**: `my_dbt_project`
     - **Database**: `[1] snowflake`
     - **Account**: `ABC-XYZ` (d·∫°ng `ABC-XYZ.snowflakecomputing.com`)
     - **User**: `[Snowflake User]`
     - **Authentication**: `[1] password`
     - **Password**: `[Snowflake Password]`
     - **Role**: `DBT_ROLE`
     - **Warehouse**: `DBT_WH`
     - **Database**: `DBT_DB`
     - **Schema**: `DBT_SCHEMA`
     - **Threads**: `1`

7. **Ki·ªÉm tra k·∫øt n·ªëi**  
   - Ch·∫°y l·ªánh ki·ªÉm tra:

   ```bash
   dbt debug
   ```

   - N·∫øu g·∫∑p l·ªói, ch·ªânh s·ª≠a file `profiles.yml`:

   ```bash
   cd $HOME/.dbt
   nano profiles.yml
   ```

   - L∆∞u file: `Ctrl + O`, `Enter`, tho√°t: `Ctrl + X`.

8. **C·∫•u h√¨nh b·ªï sung cho DBT**  
   - Ch·ªânh s·ª≠a `dbt_project.yml` ƒë·ªÉ ph√¢n v√πng d·ªØ li·ªáu:

   ```yaml
   models:
       my_dbt_project:
           staging:
               +materialized: view
               snowflake_warehouse: DBT_WH
           marts:
               +materialized: table
               snowflake_warehouse: DBT_WH
   ```

   - T·∫°o th∆∞ m·ª•c `staging` v√† `marts` trong th∆∞ m·ª•c `models`.

   - T·∫°o file `packages.yml` ƒë·ªÉ c√†i ƒë·∫∑t package b·ªï sung:

   ```yaml
   packages:
     - package: dbt-labs/dbt_utils
       version: 1.1.1
   ```

   - C√†i ƒë·∫∑t package:

   ```bash
   dbt deps
   ```

9. **C·∫•u tr√∫c d·ª± √°n DBT**  
   - **model-paths**: ["models"]  
     - T·∫°o file `.sql` trong th∆∞ m·ª•c `models` ƒë·ªÉ ƒë·ªãnh nghƒ©a b·∫£ng. S·ª≠ d·ª•ng Jinja ƒë·ªÉ tham chi·∫øu b·∫£ng ([T√†i li·ªáu Jinja](https://docs.getdbt.com/docs/build/jinja-macros)).
     - Ch·∫°y to√†n b·ªô model:

     ```bash
     dbt run
     ```

     - Ho·∫∑c ch·∫°y m·ªôt file c·ª• th·ªÉ:

     ```bash
     dbt run -s ten_file_sql.sql
     ```

   - **analysis-paths**: ["analyses"]  
     - L∆∞u tr·ªØ c√°c ph√¢n t√≠ch SQL.

   - **test-paths**: ["tests"]  
     - **Generic Test** (file `.yml` trong `models/marts` ho·∫∑c `models/staging`):

     ```yaml
     models:
       - name: fct_orders
         columns:
           - name: order_key
             tests:
               - not_null
               - unique
               - relationships:
                   to: ref('stg_tpch_orders')
                   field: order_key
                   severity: warn
           - name: order_status
             tests:
               - accepted_values:
                   values: ['F', 'O', 'P']
     ```

     - **Static Test** (file `.sql` trong `tests`):

     ```sql
     SELECT *
     FROM {{ ref('fct_orders') }} as oi
     WHERE oi.total_discount_amount > 0
     ```

     - Ch·∫°y test:

     ```bash
     dbt test
     ```

   - **seed-paths**: ["seeds"]  
     - L∆∞u tr·ªØ file tƒ©nh (v√≠ d·ª•: b·∫£ng Master CSV).

   - **macro-paths**: ["macros"]  
     - T·∫°o macro trong file `.sql` ([T√†i li·ªáu Macro](https://docs.getdbt.com/docs/build/jinja-macros)):

     ```sql
     {% macro discounted_amount(extended_price, discount_percentage, scale=2) %}
         (-1 * {{ extended_price }} * {{ discount_percentage }})::decimal(16, {{ scale }})
     {% endmacro %}
     ```

   - **snapshot-paths**: ["snapshots"]  
     - H·ªó tr·ª£ incremental models.

---

### 3. Docker + Airflow + Astro Cosmos üê≥

1. **C√†i ƒë·∫∑t Docker**  
   - Tham kh·∫£o h∆∞·ªõng d·∫´n t·∫°i [Docker Docs](https://docs.docker.com/engine/install/ubuntu/) ho·∫∑c [Digital Ocean](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-20-04).

2. **C√†i ƒë·∫∑t Astro CLI**  
   - Ch·∫°y l·ªánh c√†i ƒë·∫∑t:

   ```bash
   curl -sSL https://install.astronomer.io | sudo bash
   astro version
   ```

3. **T·∫°o th∆∞ m·ª•c DAGs**  
   - T·∫°o th∆∞ m·ª•c ri√™ng cho DAGs:

   ```bash
   cd ../
   mkdir dbt-dag
   cd dbt-dag
   ```

4. **Kh·ªüi ƒë·ªông Astro**  
   - T·∫°o file `Dockerfile`:

   ```dockerfile
   FROM astrocrpublic.azurecr.io/runtime:3.0-2

   RUN python3 -m venv venv && source venv/bin/activate && \
       pip install --no-cache-dir dbt-snowflake && deactivate
   ```

   - T·∫°o file `requirements.txt`:

   ```text
   astronomer-cosmos
   apache-airflow-providers-snowflake
   ```

   - Kh·ªüi t·∫°o d·ª± √°n Astro:

   ```bash
   astro dev init
   ```

   - Astro s·∫Ω t·ª± ƒë·ªông k√©o image v√† ch·∫°y container, truy c·∫≠p Airflow t·∫°i `localhost:8080`.

5. **T·∫°o th∆∞ m·ª•c DBT trong DAGs**  
   - T·∫°o th∆∞ m·ª•c `dbt` trong `dags`:

   ```bash
   cd dags
   mkdir dbt
   cd dbt
   ```

6. **Sao ch√©p d·ª± √°n DBT**  
   - Copy th∆∞ m·ª•c `my_dbt_project` v√†o `dags/dbt`.

7. **T·∫°o DAG ƒë·∫ßu ti√™n**  
   - T·∫°o file DAG (v√≠ d·ª•: `dbt_dag.py`) trong th∆∞ m·ª•c `dags`:

   ```python
   import os
   from datetime import datetime
   from cosmos import DbtDag, ProjectConfig, ProfileConfig, ExecutionConfig
   from cosmos.profiles import SnowflakeUserPasswordProfileMapping

   profile_config = ProfileConfig(
       profile_name="default",
       target_name="dev",
       profile_mapping=SnowflakeUserPasswordProfileMapping(
           conn_id="snowflake_conn",
           profile_args={"database": "dbt_db", "schema": "dbt_schema"},
       )
   )

   dbt_snowflake_dag = DbtDag(
       project_config=ProjectConfig("/usr/local/airflow/dags/dbt/my_dbt_project"),
       operator_args={"install_deps": True},
       profile_config=profile_config,
       execution_config=ExecutionConfig(dbt_executable_path=f"{os.environ['AIRFLOW_HOME']}/venv/bin/dbt"),
       schedule_interval="@daily",
       start_date=datetime(2023, 9, 10),
       catchup=False,
       dag_id="dbt_dag",
   )
   ```

   - **L∆∞u √Ω**: ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n trong `ProjectConfig` v√† `dbt_executable_path` kh·ªõp v·ªõi c·∫•u h√¨nh `venv`.

---

## üöÄ B·∫Øt ƒë·∫ßu

1. Ho√†n th√†nh c√°c b∆∞·ªõc c√†i ƒë·∫∑t Snowflake, DBT, v√† Airflow theo h∆∞·ªõng d·∫´n.
2. Ch·∫°y l·ªánh `dbt run` ƒë·ªÉ x√¢y d·ª±ng c√°c model trong Snowflake.
3. K√≠ch ho·∫°t DAG trong Airflow ƒë·ªÉ t·ª± ƒë·ªông h√≥a pipeline.
4. Theo d√µi v√† ki·ªÉm tra k·∫øt qu·∫£ qua giao di·ªán Airflow t·∫°i `localhost:8080`.

---

## üìö T√†i li·ªáu tham kh·∫£o

- [DBT Documentation](https://docs.getdbt.com/)
- [Snowflake Documentation](https://docs.snowflake.com/)
- [Astro Cosmos Documentation](https://astronomer.io/docs/)
- [Apache Airflow Documentation](https://airflow.apache.org/docs/)

---

## üôå ƒê√≥ng g√≥p

N·∫øu b·∫°n c√≥ √Ω t∆∞·ªüng c·∫£i thi·ªán d·ª± √°n, vui l√≤ng t·∫°o **Pull Request** ho·∫∑c m·ªü **Issue** tr√™n repository!